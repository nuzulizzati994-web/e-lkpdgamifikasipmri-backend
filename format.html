<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link
  href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300..700&display=swap"
  rel="stylesheet"
/>
<style>
  .no-border input {
    font-family: "Fredoka" !important;
    border: none;
    outline: none;
  }
  .circle-paint {
    height: 100px;
    width: 100px;
    border-radius: 1000px;
    background: #000000;
    transition: all 0.3s ease;
  }
</style>
<script>
  function safeParseMaybeString(v) {
    if (typeof v === "string") {
      try {
        return JSON.parse(v);
      } catch {
        return v;
      }
    }
    return v;
  }
  window.ip = function () {
    if (typeof Varip === "undefined") return null;
    return Varip.getValue();
  };
  document.addEventListener("DOMContentLoaded", async () => {
    const api = axios.create({
      baseURL: `https://${ip()}/api`,
      timeout: 10000,
    });
    api.interceptors.request.use(
      (config) => {
        try {
          if (window.VarToken?.getValue) {
            const token = VarToken.getValue();
            if (token) {
              config.headers.Authorization = `Bearer ${token}`;
            }
          }
        } catch (e) {
          console.warn("Token belum siap");
        }
        return config;
      },
      (error) => Promise.reject(error)
    );
    window.api = api;
    async function check() {
      try {
        const token = VarToken.getValue();
        const request = await api.post("/auth/check", {
          token,
        });
        if (
          request.data.status == "failed" &&
          !window.location.href.includes("login")
        ) {
          trivExitPage("splash_screen_login_page_login.html", true);
        }
        if (request.data.status == "success") {
          if (window.location.href.includes("login")) {
            trivExitPage("homepage_homepage.html", true);
          }
          Varpoints.set(JSON.stringify(request.data.progress.points));
          Varstage.set(request.data.progress.stage);
          totalPoints(request.data.progress.points);
        }
      } catch (error) {
        console.error("Error:", error);
      }
    }
    await check();
    let pointsRaw =
      typeof Varpoints !== "undefined" ? Varpoints.getValue() : "{}";
    let points = safeParseMaybeString(pointsRaw);
    if (!points || typeof points !== "object") points = {};
    console.log("initial points:", points);
    function ipLocal() {
      return typeof Varip !== "undefined" ? Varip.getValue() : null;
    }
    function essay(array, answer, kasus, quest, point) {
      let acc = 0;
      const lowerAns = (answer || "").toLowerCase();
      array.forEach((item) => {
        const check = item.some((key) => {
          if (typeof key === "object") {
            let checker = false;
            key.forEach((value) => {
              if (lowerAns.includes(value)) checker = true;
              else {
                checker = false;
                return;
              }
            });
            return checker;
          } else {
            return lowerAns.includes(key);
          }
        });
        if (check) acc += point;
      });
      setPoint(kasus, quest, acc);
    }
    async function setPoint(kasus, quest, pointValue) {
      try {
        const temp = points["case" + kasus] || {};
        temp[quest] = pointValue;
        points["case" + kasus] = temp;
        if (typeof Varpoints !== "undefined") {
          Varpoints.set(JSON.stringify(points));
        }
        console.log("points updated:", points);
        const data = collectPageValues();
        const stage = parseInt(Varstage.getValue());
        const request = await api.post(
          "https://" + ip() + "/api/progress/save",
          {
            caseId: kasus,
            data,
            point: points,
            stage,
          }
        );
        if (request.status == 200) {
          console.log("Success");
        }
      } catch (error) {
        console.error("Error:", error);
      }
    }
    async function casePoints(kasus, minPoint) {
      try {
        const target = points["case" + kasus] || {};
        const point =
          Object.keys(target).length > 0
            ? Object.values(target).reduce((a, b) => a + b, 0)
            : 0;
            let totalPoint = 0;
        Object.values(points).forEach((point) => {
          totalPoint += Object.values(point).reduce((a, b) => a + b, 0);
        });
        if (typeof VarTotalPoint !== "undefined") VarTotalPoint.set(totalPoint);
        if (typeof VarFinalPoint !== "undefined") VarFinalPoint.set(point);
        console.log(point, minPoint);
        const status = point >= minPoint;
        if (status) Varstage.set(kasus);
        const data = collectPageValues();
        const request = await api.post(
          "https://" + ip() + "/api/progress/save",
          {
            caseId: kasus,
            data,
            point: points,
            stage: status && kasus,
          }
        );
        if (request.status == 200) {
          console.log("Success");
        }
        trivExitPage(
          `kasus_${kasus}_result_${kasus}${status ? "" : "x"}.html`,
          true
        );
      } catch (error) {
        console.error("Error:", error);
      }
    }
    function totalPoints(data) {
     
      let total = 0;
      Object.values(data || points).forEach((k) => {
        total += Object.values(k).reduce((a, b) => a + b, 0);
      });
      console.log(data)
      console.log(total)
      VarTotalPoint.set(total);
    }
    function pt(status, kasus, quest, point) {
      const newPoint = status && point ? point : 0;
      setPoint(kasus, quest, newPoint);
    }
    function dl(ratio, kasus, quest, point, ...value) {
      const dec = ratio.reduce((a, b) => a / b);
      const valueRatio = value.reduce((a, b) => a / b);
      const newPoint = dec === valueRatio ? point : 0;
      setPoint(kasus, quest, newPoint);
    }
    function collectPageValues() {
      let data = {};
      let droplist = [];
      for (let key in window) {
        if (key.startsWith("Var")) {
          try {
            let varObj = window[key];
            if (varObj && typeof varObj.getValue === "function") {
              let cleanName = key.replace("Var", "");
              let arrayName = cleanName.split("_");
              console.log(cleanName);
              console.log("a");
              const allow = ["q", "droplist", "e", "i", "c", "k", "f"];
              const filter = allow.filter((v) => arrayName[2] == v);
              if (filter.length !== 0 && arrayName.length >= 3) {
                console.log(arrayName);
                if (arrayName[2] == "droplist") {
                  const refKey =
                    "Var" + cleanName.split("_").slice(0, -1).join("_");
                  if (!droplist.includes(refKey)) {
                    droplist.push(refKey);
                    const droplistValue = Object.keys(window)
                      .filter((k) => k.startsWith(refKey))
                      .map((k) => window[k].getValue())
                      .join(";");
                    data[arrayName[1]] = droplistValue;
                  }
                } else {
                  data[arrayName[1]] = varObj.getValue();
                }
              }
            }
          } catch (e) {
            console.log("skip:", key);
          }
        }
      }
      console.log("All page values:", data);
      return data;
    }
    async function login() {
      const url = "https://" + ip() + "/api/auth/login";
      const username = Varusername_1.getValue();
      const password = Varpassword_1.getValue().value;
      await axios
        .post(url, { username, password })
        .then(async function (response) {
          console.log("Login sukses:", response.data);
          if (response.data && response.data.token) {
            VarToken.set(response.data.token);
            await check()
            trivExitPage("homepage_homepage.html", true);
          } else {
            alert("Login gagal: token tidak ditemukan.");
          }
        })
        .catch(function (error) {
          console.error("Error:", error);
          if (error.response) {
            alert("Login gagal: " + error.response.data.message);
          } else {
            alert("Tidak bisa terhubung ke server!");
          }
        });
    }
    async function signup() {
      const url = "https://" + ip() + "/api/auth/signup";
      const username = Varusername_1.getValue();
      const password = Varpassword_1.getValue();
      axios
        .post(url, { username, password })
        .then(function (response) {
          console.log("Login sukses:", response.data);
          if (response.data && response.data.token) {
            VarToken.set(response.data.token);
            trivExitPage("homepage_homepage.html", true);
          } else {
            alert("Login gagal: token tidak ditemukan.");
          }
        })
        .catch(function (error) {
          console.error("Error:", error);
          if (error.response) {
            alert("Login gagal: " + error.response.data.message);
          } else {
            alert("Tidak bisa terhubung ke server!");
          }
        });
    }
    window.collectPageValues = collectPageValues;
    window.ip = ipLocal;
    window.pt = pt;
    window.essay = essay;
    window.dl = dl;
    window.casePoints = casePoints;
    window.login = login;
    window.signup = signup;
    window.totalPoint = totalPoints;
  });
</script>
